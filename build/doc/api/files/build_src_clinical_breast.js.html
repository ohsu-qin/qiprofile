<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>build/src/clinical/breast.js - qiprofile API</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div class="yui3-g">
        <div id="sidebar" class="yui3-u">
            <div class="logo">
              <a href="../index.html">
                  qiprofile API
              </a>
            </div>
            
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/clinical.html">clinical</a>
                            </li>
                            <li><a href="../modules/collection.html">collection</a>
                            </li>
                            <li><a href="../modules/collections.html">collections</a>
                            </li>
                            <li><a href="../modules/common.html">common</a>
                            </li>
                            <li><a href="../modules/configuration.html">configuration</a>
                            </li>
                            <li><a href="../modules/controls.html">controls</a>
                            </li>
                            <li><a href="../modules/data.html">data</a>
                            </li>
                            <li><a href="../modules/date.html">date</a>
                            </li>
                            <li><a href="../modules/error.html">error</a>
                            </li>
                            <li><a href="../modules/file.html">file</a>
                            </li>
                            <li><a href="../modules/help.html">help</a>
                            </li>
                            <li><a href="../modules/home.html">home</a>
                            </li>
                            <li><a href="../modules/image.html">image</a>
                            </li>
                            <li><a href="../modules/imageSequence.html">imageSequence</a>
                            </li>
                            <li><a href="../modules/main.html">main</a>
                            </li>
                            <li><a href="../modules/object.html">object</a>
                            </li>
                            <li><a href="../modules/page.html">page</a>
                            </li>
                            <li><a href="../modules/project.html">project</a>
                            </li>
                            <li><a href="../modules/projects.html">projects</a>
                            </li>
                            <li><a href="../modules/rest.html">rest</a>
                            </li>
                            <li><a href="../modules/roman.html">roman</a>
                            </li>
                            <li><a href="../modules/session.html">session</a>
                            </li>
                            <li><a href="../modules/string.html">string</a>
                            </li>
                            <li><a href="../modules/subject.html">subject</a>
                            </li>
                            <li><a href="../modules/testing.html">testing</a>
                            </li>
                            <li><a href="../modules/visualization.html">visualization</a>
                            </li>
                            <li><a href="../modules/volume.html">volume</a>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/AppComponent.html">AppComponent</a></li>
                            <li><a href="../classes/AppModule.html">AppModule</a></li>
                            <li><a href="../classes/Breast.html">Breast</a></li>
                            <li><a href="../classes/BreastNormalizedAssay.html">BreastNormalizedAssay</a></li>
                            <li><a href="../classes/BreastPathology.html">BreastPathology</a></li>
                            <li><a href="../classes/CascadeSelectComponent.html">CascadeSelectComponent</a></li>
                            <li><a href="../classes/ClinicalEncounter.html">ClinicalEncounter</a></li>
                            <li><a href="../classes/CollectionActivatedRouteStub.html">CollectionActivatedRouteStub</a></li>
                            <li><a href="../classes/CollectionComponent.html">CollectionComponent</a></li>
                            <li><a href="../classes/CollectionComponentSpec.html">CollectionComponentSpec</a></li>
                            <li><a href="../classes/CollectionItemComponent.html">CollectionItemComponent</a></li>
                            <li><a href="../classes/CollectionListPage.html">CollectionListPage</a></li>
                            <li><a href="../classes/CollectionListSpec.html">CollectionListSpec</a></li>
                            <li><a href="../classes/CollectionModule.html">CollectionModule</a></li>
                            <li><a href="../classes/CollectionRouterStub.html">CollectionRouterStub</a></li>
                            <li><a href="../classes/CollectionsActivatedRouteStub.html">CollectionsActivatedRouteStub</a></li>
                            <li><a href="../classes/CollectionsComponent.html">CollectionsComponent</a></li>
                            <li><a href="../classes/CollectionsComponentSpec.html">CollectionsComponentSpec</a></li>
                            <li><a href="../classes/CollectionsHelpComponent.html">CollectionsHelpComponent</a></li>
                            <li><a href="../classes/CollectionsHelpServiceStub.html">CollectionsHelpServiceStub</a></li>
                            <li><a href="../classes/CollectionsHelpTextComponent.html">CollectionsHelpTextComponent</a></li>
                            <li><a href="../classes/CollectionsModule.html">CollectionsModule</a></li>
                            <li><a href="../classes/CollectionsResource.html">CollectionsResource</a></li>
                            <li><a href="../classes/CollectionsService.html">CollectionsService</a></li>
                            <li><a href="../classes/CollectionsServiceStub.html">CollectionsServiceStub</a></li>
                            <li><a href="../classes/CollectionSubectServiceStub.html">CollectionSubectServiceStub</a></li>
                            <li><a href="../classes/ColorBarDirective.html">ColorBarDirective</a></li>
                            <li><a href="../classes/CommonModule.html">CommonModule</a></li>
                            <li><a href="../classes/ConfigurationService.html">ConfigurationService</a></li>
                            <li><a href="../classes/ConfigurationServiceSpec.html">ConfigurationServiceSpec</a></li>
                            <li><a href="../classes/ControlsModule.html">ControlsModule</a></li>
                            <li><a href="../classes/CorrelationComponent.html">CorrelationComponent</a></li>
                            <li><a href="../classes/DateHelper.html">DateHelper</a></li>
                            <li><a href="../classes/DateHelperSpec.html">DateHelperSpec</a></li>
                            <li><a href="../classes/Encounter.html">Encounter</a></li>
                            <li><a href="../classes/ErrorComponent.html">ErrorComponent</a></li>
                            <li><a href="../classes/FileService.html">FileService</a></li>
                            <li><a href="../classes/FileServiceSpec.html">FileServiceSpec</a></li>
                            <li><a href="../classes/Findable.html">Findable</a></li>
                            <li><a href="../classes/HelpComponent.html">HelpComponent</a></li>
                            <li><a href="../classes/HelpService.html">HelpService</a></li>
                            <li><a href="../classes/HomeComponent.html">HomeComponent</a></li>
                            <li><a href="../classes/IamgeSequenceService.html">IamgeSequenceService</a></li>
                            <li><a href="../classes/Image.html">Image</a></li>
                            <li><a href="../classes/ImageComponent.html">ImageComponent</a></li>
                            <li><a href="../classes/ImageModule.html">ImageModule</a></li>
                            <li><a href="../classes/ImageSequence.html">ImageSequence</a></li>
                            <li><a href="../classes/ImageSequenceServiceSpec.html">ImageSequenceServiceSpec</a></li>
                            <li><a href="../classes/ImageSequenceSessionServiceStub.html">ImageSequenceSessionServiceStub</a></li>
                            <li><a href="../classes/ImageSequenceSpec.html">ImageSequenceSpec</a></li>
                            <li><a href="../classes/ImageStore.html">ImageStore</a></li>
                            <li><a href="../classes/LabelMap.html">LabelMap</a></li>
                            <li><a href="../classes/Modeling.html">Modeling</a></li>
                            <li><a href="../classes/ModelingResult.html">ModelingResult</a></li>
                            <li><a href="../classes/ModelingResults.html">ModelingResults</a></li>
                            <li><a href="../classes/ObjectHelper.html">ObjectHelper</a></li>
                            <li><a href="../classes/Page.html">Page</a></li>
                            <li><a href="../classes/PageComponent.html">PageComponent</a></li>
                            <li><a href="../classes/PageModule.html">PageModule</a></li>
                            <li><a href="../classes/PapayaService.html">PapayaService</a></li>
                            <li><a href="../classes/ParameterResult.html">ParameterResult</a></li>
                            <li><a href="../classes/Pathology.html">Pathology</a></li>
                            <li><a href="../classes/PlayerComponent.html">PlayerComponent</a></li>
                            <li><a href="../classes/ProjectItemComponent.html">ProjectItemComponent</a></li>
                            <li><a href="../classes/ProjectListPage.html">ProjectListPage</a></li>
                            <li><a href="../classes/ProjectListSpec.html">ProjectListSpec</a></li>
                            <li><a href="../classes/ProjectsComponent.html">ProjectsComponent</a></li>
                            <li><a href="../classes/ProjectsComponentSpec.html">ProjectsComponentSpec</a></li>
                            <li><a href="../classes/ProjectsHelpComponent.html">ProjectsHelpComponent</a></li>
                            <li><a href="../classes/ProjectsHelpServiceStub.html">ProjectsHelpServiceStub</a></li>
                            <li><a href="../classes/ProjectsHelpTextComponent.html">ProjectsHelpTextComponent</a></li>
                            <li><a href="../classes/ProjectsModule.html">ProjectsModule</a></li>
                            <li><a href="../classes/ProjectsResource.html">ProjectsResource</a></li>
                            <li><a href="../classes/ProjectsService.html">ProjectsService</a></li>
                            <li><a href="../classes/ProjectsServiceStub.html">ProjectsServiceStub</a></li>
                            <li><a href="../classes/PropertyTableComponent.html">PropertyTableComponent</a></li>
                            <li><a href="../classes/RCB.html">RCB</a></li>
                            <li><a href="../classes/Registration.html">Registration</a></li>
                            <li><a href="../classes/RegistrationSpec.html">RegistrationSpec</a></li>
                            <li><a href="../classes/REST.html">REST</a></li>
                            <li><a href="../classes/RestResource.html">RestResource</a></li>
                            <li><a href="../classes/RESTSpec.html">RESTSpec</a></li>
                            <li><a href="../classes/Roman.html">Roman</a></li>
                            <li><a href="../classes/RomanSpec.html">RomanSpec</a></li>
                            <li><a href="../classes/Sarcoma.html">Sarcoma</a></li>
                            <li><a href="../classes/Scan.html">Scan</a></li>
                            <li><a href="../classes/ScanSpec.html">ScanSpec</a></li>
                            <li><a href="../classes/ScatterPlotDirective.html">ScatterPlotDirective</a></li>
                            <li><a href="../classes/Session.html">Session</a></li>
                            <li><a href="../classes/SessionActivatedRouteStub.html">SessionActivatedRouteStub</a></li>
                            <li><a href="../classes/SessionComponent.html">SessionComponent</a></li>
                            <li><a href="../classes/SessionComponentSpec.html">SessionComponentSpec</a></li>
                            <li><a href="../classes/SessionDetailResource.html">SessionDetailResource</a></li>
                            <li><a href="../classes/SessionDetailResourceStub.html">SessionDetailResourceStub</a></li>
                            <li><a href="../classes/SessiondRouterStub.html">SessiondRouterStub</a></li>
                            <li><a href="../classes/SessionModule.html">SessionModule</a></li>
                            <li><a href="../classes/SessionService.html">SessionService</a></li>
                            <li><a href="../classes/SessionServiceSpec.html">SessionServiceSpec</a></li>
                            <li><a href="../classes/SessionServiceStub.html">SessionServiceStub</a></li>
                            <li><a href="../classes/SessionSpec.html">SessionSpec</a></li>
                            <li><a href="../classes/SessionSubjectResourceStub.html">SessionSubjectResourceStub</a></li>
                            <li><a href="../classes/SessionTumorExtent.html">SessionTumorExtent</a></li>
                            <li><a href="../classes/SliderDirective.html">SliderDirective</a></li>
                            <li><a href="../classes/SparkLineDirective.html">SparkLineDirective</a></li>
                            <li><a href="../classes/StringHelper.html">StringHelper</a></li>
                            <li><a href="../classes/StringHelperSpec.html">StringHelperSpec</a></li>
                            <li><a href="../classes/Subject.html">Subject</a></li>
                            <li><a href="../classes/SubjectActivatedRouteStub.html">SubjectActivatedRouteStub</a></li>
                            <li><a href="../classes/SubjectChangeDetectorRefStub.html">SubjectChangeDetectorRefStub</a></li>
                            <li><a href="../classes/SubjectComponent.html">SubjectComponent</a></li>
                            <li><a href="../classes/SubjectComponentSpec.html">SubjectComponentSpec</a></li>
                            <li><a href="../classes/SubjectdRouterStub.html">SubjectdRouterStub</a></li>
                            <li><a href="../classes/SubjectModule.html">SubjectModule</a></li>
                            <li><a href="../classes/SubjectResource.html">SubjectResource</a></li>
                            <li><a href="../classes/SubjectResourceStub.html">SubjectResourceStub</a></li>
                            <li><a href="../classes/SubjectService.html">SubjectService</a></li>
                            <li><a href="../classes/SubjectServiceSpec.html">SubjectServiceSpec</a></li>
                            <li><a href="../classes/SubjectServiceStub.html">SubjectServiceStub</a></li>
                            <li><a href="../classes/SubjectSpec.html">SubjectSpec</a></li>
                            <li><a href="../classes/Table.html">Table</a></li>
                            <li><a href="../classes/TimeSeries.html">TimeSeries</a></li>
                            <li><a href="../classes/TNM.html">TNM</a></li>
                            <li><a href="../classes/ToggleHelpComponent.html">ToggleHelpComponent</a></li>
                            <li><a href="../classes/VisualizationModule.html">VisualizationModule</a></li>
                            <li><a href="../classes/Volume.html">Volume</a></li>
                            <li><a href="../classes/VolumeComponent.html">VolumeComponent</a></li>
                            <li><a href="../classes/VolumeDetailPage.html">VolumeDetailPage</a></li>
                            <li><a href="../classes/VolumeImageSequenceServiceStub.html">VolumeImageSequenceServiceStub</a></li>
                            <li><a href="../classes/VolumeModule.html">VolumeModule</a></li>
                            <li><a href="../classes/VolumeService.html">VolumeService</a></li>
                            <li><a href="../classes/VolumeServiceSpec.html">VolumeServiceSpec</a></li>
                            <li><a href="../classes/VolumeSpec.html">VolumeSpec</a></li>
                            <li><a href="../classes/XNAT.html">XNAT</a></li>
                            <li><a href="../classes/XNATSpec.html">XNATSpec</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div class="version-info">
              Version: 2.1.1
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><div class="title">
  <h1 class="file-name">build/src/clinical/breast.js</h1>
</div>

<pre class="code prettyprint linenums">
(function() {
  import * as _ from &quot;lodash&quot;;
  import ObjectHelper from &quot;../object/object-helper.coffee&quot;;
  var Breast, RCB, STAGES, _rcbClass, _rcbIndex, _recurrenceScore;

  STAGES = [[&#x27;1A&#x27;, &#x27;2A&#x27;, &#x27;3A&#x27;, &#x27;3C&#x27;], [&#x27;1A&#x27;, &#x27;2A&#x27;, &#x27;3A&#x27;, &#x27;3C&#x27;], [&#x27;2A&#x27;, &#x27;2B&#x27;, &#x27;3A&#x27;, &#x27;3C&#x27;], [&#x27;2B&#x27;, &#x27;3A&#x27;, &#x27;3A&#x27;, &#x27;3C&#x27;], [&#x27;3B&#x27;, &#x27;3B&#x27;, &#x27;3B&#x27;, &#x27;3C&#x27;]];

  _rcbIndex = function(extent, rcb) {
    var PROPS, inSitu, invasion, invasionFactor, missingProp, nodeBase, nodeFactor, overall, posNodeFactor, size;
    PROPS = [&#x27;tumorCellDensity&#x27;, &#x27;dcisCellDensity&#x27;, &#x27;positiveNodeCount&#x27;, &#x27;largestNodalMetastasisLength&#x27;];
    missingProp = function() {
      return _.some(PROPS, function(prop) {
        return _.isNil(rcb[prop]);
      });
    };
    if (_.isNil(extent) || _.isNil(rcb) || missingProp()) {
      return null;
    }
    size = Math.sqrt(extent.tumorLength * extent.tumorWidth);
    overall = rcb.tumorCellDensity / 100;
    inSitu = rcb.dcisCellDensity / 100;
    invasion = (1 - inSitu) * overall;
    invasionFactor = 1.4 * Math.pow(invasion * size, 0.17);
    posNodeFactor = 1 - Math.pow(0.75, rcb.positiveNodeCount);
    nodeBase = 4 * posNodeFactor * rcb.largestNodalMetastasisLength;
    nodeFactor = Math.pow(nodeBase, 0.17);
    return invasionFactor + nodeFactor;
  };

  _rcbClass = function(index) {
    if (_.isNil(index)) {
      return null;
    }
    if (index === 0) {
      return 0;
    } else if (index &lt; 1.36) {
      return 1;
    } else if (index &lt; 3.28) {
      return 2;
    } else {
      return 3;
    }
  };


  /**
   * The BreastPathology residual cancer burden.
   * The index and class properties are calculated as described in
   * &lt;JCO 25:28 4414-4422 http://jco.ascopubs.org/content/25/28/4414.full&gt;.
   *
   * @module clinical
   * @class RCB
   */

  RCB = {
    extend: function(rcb, tumor) {
      rcb.tumor = tumor;
      Object.defineProperties(rcb, {

        /**
         * The RCB index.
         *
         * @class RCB
         * @property index
         */
        index: {
          get: function() {
            return _rcbIndex(this.tumor.extent, this);
          }
        },

        /**
         * The RCB class based on the RCB index cut-offs.
         *
         * @class RCB
         * @property class
         */
        &quot;class&quot;: {
          get: function() {
            return _rcbClass(this.index);
          }
        }
      });
      return rcb;
    }
  };

  _recurrenceScore = function(assay) {
    var er, erUnscaled, her2, her2Unscaled, invasion, proliferation, proliferationUnscaled, recurrenceScaled, recurrenceUnscaled;
    her2Unscaled = (0.9 * assay.her2.grb7) + (0.1 * assay.her2.her2);
    her2 = Math.max(8, her2Unscaled);
    erUnscaled = (0.8 * assay.estrogen.er) + (1.2 * assay.estrogen.pgr) + assay.estrogen.bcl2 + assay.estrogen.scube2;
    er = erUnscaled / 4;
    proliferationUnscaled = (assay.proliferation.survivin + assay.proliferation.ki67 + assay.proliferation.mybl2 + assay.proliferation.ccnb1 + assay.proliferation.stk15) / 5;
    proliferation = Math.max(6.5, proliferationUnscaled);
    invasion = (assay.invasion.ctsl2 + assay.invasion.mmp11) / 2;
    recurrenceUnscaled = (0.47 * her2) - (0.34 * er) + (1.04 * proliferation) + (0.10 * invasion) + (0.05 * assay.cd68) - (0.08 * assay.gstm1) - (0.07 * assay.bag1);
    if (isNaN(recurrenceUnscaled)) {
      return null;
    }
    recurrenceScaled = Math.round(20 * (recurrenceUnscaled - 6.7));
    return Math.max(0, Math.min(recurrenceScaled, 100));
  };


  /**
   * The static breast utility.
   *
   * @module clinical
   * @class Breast
   * @static
   */

  Breast = {

    /**
     * The breast cancer grade determinants, consisting of the
     * following properties:
     * * *RANGES* - the three grade score ranges, as follows:
     *   - Grade 1: score 3,5
     *   - Grade 2: score 6,7
     *   - Grade 3: score 8,9
     * * *SCORES* - the grade score factor properties
     *   &#x60;tubularFormation&#x60;, &#x60;mitoticCount&#x60; and &#x60;nuclearPleomorphism&#x60;
     *
     * @property Grade
     * @static
     */
    Grade: {
      RANGES: [[3, 4, 5], [6, 7], [8, 9]],
      SCORES: [&#x27;tubularFormation&#x27;, &#x27;mitoticCount&#x27;, &#x27;nuclearPleomorphism&#x27;]
    },

    /**
     * @method extend
     * @param encounter the Breast patient clinical encounter
     * @return the augmented clinical encounter object
     */
    extend: function(encounter) {
      var assay, i, len, ref, results, tumor;
      if (encounter.pathology) {
        ref = encounter.pathology.tumors;
        results = [];
        for (i = 0, len = ref.length; i &lt; len; i++) {
          tumor = ref[i];

          /**
           * The Breast pathology.
           *
           * @module clinical
           * @class BreastPathology
           */
          if (tumor.rcb) {
            RCB.extend(tumor.rcb, tumor);
          }
          assay = _.get(tumor, &#x27;geneticExpression.normalizedAssay&#x27;);
          if (assay) {

            /**
             * The Breast gene expression normalized assay.
             *
             * @module clinical
             * @class BreastNormalizedAssay
             */
            results.push(Object.defineProperties(assay, {

              /**
               * Returns the cancer recurrence score. This score is calculated from
               * a genetic expression assay according to algorithm in Figure 1 of
               * the following paper:
               *
               *   Paik, et al., &#x27;A Multigene Assay to Predict Recurrence of
               *   Tamoxifen-Treated, Node-Negative Breast Cancer&#x27;,
               *   N Engl J Med 2004; 351:2817-2826
               *   (http://www.nejm.org/doi/full/10.1056/NEJMoa041588)
               *
               * 1f metastasis exists (M1), then the stage is 4.
               * Otherwise, the stage is determined by T and N scores as
               * defined in the tumor type factory STAGES associative
               * lookup table.
               *
               * @class BreastNormalizedAssay
               * @property recurrenceScore
               */
              recurrenceScore: {
                get: function() {
                  return _recurrenceScore(this);
                }
              }
            }));
          } else {
            results.push(void 0);
          }

          /**
           * The Breast pathology.
           *
           * @module clinical
           * @class BreastPathology
           */
        }
        return results;
      }
    },

    /**
     * @module clinical
     * @class Breast
     * @method stageExtent
     * @return the sorted stage values
     */
    stageExtent: function() {
      var plus4;
      plus4 = _.partialRight(_.union, [&#x27;4&#x27;]);
      return _.flow(_.flatten, plus4, _.uniq, _.sort)(STAGES);
    },

    /**
     * Returns the cancer stage.
     *
     * 1f metastasis exists (M1), then the stage is 4.
     * Otherwise, the stage is determined by T and N scores as
     * defined in the tumor type factory STAGES associative
     * lookup table.
     *
     * @module clinical
     * @class Breast
     * @method stage
     * @param tnm the TNM object
     * @return the cancer stage object, as described in tnm.coffee
     *    stage
     */
    stage: function(tnm) {
      var find, n, t;
      if (tnm.metastasis) {
        return &#x27;4&#x27;;
      }
      t = tnm.size.tumorSize;
      n = tnm.lymphStatus;
      find = function(table, value) {
        var result;
        return result = table[value] || (function() {
          throw new ReferenceError((&quot;Unsupported &quot; + tnm.tumorType) + (&quot; TNM: &quot; + (ObjectHelper.prettyPrint(tnm))));
        })();
      };
      return _.reduce([t, n], find, STAGES);
    }
  };

  export { Breast as default };

}).call(this);

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
</body>
</html>
